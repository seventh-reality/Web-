<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Markerless Web AR with Three.js and TensorFlow.js</title>
  <style>
    body { margin: 0; overflow: hidden; }
    canvas { display: block; }
  </style>
  
  <!-- Include Three.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <!-- Include GLTFLoader from Three.js examples -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
  <!-- TensorFlow.js (Optional for AI integration) -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.6.1/dist/tf.min.js"></script>
</head>
<body>

<script>
  let scene, camera, renderer, gltfLoader, xrSession;
  let reticle, model;

  // Set up Three.js scene
  function initThreeJS() {
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);
    renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.xr.enabled = true;  // Enable WebXR for AR
    document.body.appendChild(renderer.domElement);
  }

  // Load GLB model and add it to the scene
  function loadGLBModel() {
    gltfLoader = new THREE.GLTFLoader();
    gltfLoader.load('Steerad.glb', (gltf) => {
      model = gltf.scene;
      model.visible = false;  // Model is hidden initially
      scene.add(model);
    }, undefined, function (error) {
      console.error('An error occurred while loading the model:', error);
    });
  }

  // Handle the placement of the 3D model on the detected surface
  function placeModelAtReticle() {
    if (reticle.visible && model) {
      model.position.setFromMatrixPosition(reticle.matrix);
      model.visible = true;
    }
  }

  // Set up WebXR session for AR (with surface tracking)
  function initWebXR() {
    navigator.xr.requestSession('immersive-ar', {
      requiredFeatures: ['hit-test', 'dom-overlay'],
      domOverlay: { root: document.body }
    }).then((session) => {
      renderer.xr.setSession(session);
      xrSession = session;

      // Set up hit-test for surface tracking
      session.requestReferenceSpace('viewer').then((referenceSpace) => {
        session.requestHitTestSource({ space: referenceSpace }).then((hitTestSource) => {
          const frameOfReference = renderer.xr.getFrameOfReference();
          renderer.setAnimationLoop((timestamp, frame) => {
            let hitTestResults = frame.getHitTestResults(hitTestSource);
            if (hitTestResults.length > 0) {
              let hit = hitTestResults[0];
              reticle.visible = true;
              reticle.matrix.fromArray(hit.getPose(frameOfReference).transform.matrix);
            } else {
              reticle.visible = false;
            }
            renderer.render(scene, camera);
            placeModelAtReticle();
          });
        });
      });
    });
  }

  // Create a reticle to visualize where the object will be placed
  function createReticle() {
    const geometry = new THREE.RingGeometry(0.1, 0.15, 32).rotateX(-Math.PI / 2);
    const material = new THREE.MeshBasicMaterial({ color: 0xffffff });
    reticle = new THREE.Mesh(geometry, material);
    reticle.visible = false;
    scene.add(reticle);
  }

  // Initialize TensorFlow.js model (for AI-based tasks, optional)
  async function initTensorFlowModel() {
    const model = await tf.loadGraphModel('https://tfhub.dev/tensorflow/ssd_mobilenet_v2/1/default/1');
    console.log('TensorFlow.js model loaded');
    // Add your TensorFlow.js tasks here (e.g., object detection)
  }

  // Initialize the entire AR scene
  function initARScene() {
    initThreeJS();
    createReticle();
    loadGLBModel();
    initWebXR();
    initTensorFlowModel();  // Optional: only if you need AI-based features
  }

  window.addEventListener('load', initARScene);
</script>

</body>
</html>
